name: Build, Push, and Deploy to Cloud Run (with Cloud Build)

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Container image name'
        required: true
        type: string
      tag:
        description: 'Image tag'
        default: latest
        type: string
      region:
        description: 'GCP region'
        default: us-central1
        type: string
      project_id:
        description: 'Google Cloud Project ID'
        required: true
        type: string
      workload_identity_provider:
        description: 'Full Workload Identity Provider resource path'
        required: true
        type: string
      service_account:
        description: 'Service account email for authentication'
        required: true
        type: string
      context:
        description: 'Docker build context path'
        default: '.'
        type: string
      dockerfile:
        description: 'Path to Dockerfile'
        default: 'Dockerfile'
        type: string
      deploy_to_cloud_run:
        description: 'Whether to deploy to Cloud Run after push (true/false)'
        default: 'true'
        type: string
      service_name:
        description: 'Cloud Run service name'
        default: ''
        type: string

    outputs:
      image_uri:
        description: 'The full image URI built and pushed'
        value: ${{ jobs.build-and-deploy.outputs.image_uri }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    outputs:
      image_uri: ${{ steps.build.outputs.image_uri }}

    steps:
      # 1️⃣ Checkout source
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Authenticate to GCP via OIDC
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          token_format: access_token
          workload_identity_provider: ${{ inputs.workload_identity_provider }}
          service_account: ${{ inputs.service_account }}

      # 3️⃣ Setup gcloud CLI
      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ inputs.project_id }}

      # 4️⃣ Configure Docker to authenticate with Artifact Registry
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker "${{ inputs.region }}-docker.pkg.dev" --quiet

      # 5️⃣ Build and push Docker image
      - name: Build and Push Docker image
        id: build
        run: |
          IMAGE_URI=${{ inputs.region }}-docker.pkg.dev/${{ inputs.project_id }}/containers/${{ inputs.image_name }}:${{ inputs.tag }}
      
          echo "Building Docker image: $IMAGE_URI"
          docker build -t "$IMAGE_URI" -f "${{ inputs.dockerfile }}" "${{ inputs.context }}"
      
          echo "Pushing Docker image: $IMAGE_URI"
          docker push "$IMAGE_URI"
      
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT

      - name: Deploy to Cloud Run
        if: ${{ inputs.deploy_to_cloud_run == 'true' }}
        run: |
          IMAGE_URI=${{ steps.build.outputs.image_uri }}
          SERVICE=${{ inputs.service_name }}
          if [ -z "$SERVICE" ]; then
            SERVICE=${{ inputs.image_name }}
          fi
      
          echo "Deploying $IMAGE_URI to Cloud Run service: $SERVICE"
          gcloud run deploy "$SERVICE" \
            --image "$IMAGE_URI" \
            --region us-central1 \
            --port 80 \
            --allow-unauthenticated
      # 7️⃣ Explicit Cloud Run update (optional, ensures latest image)
      - name: Update Cloud Run service
        if: ${{ inputs.deploy_to_cloud_run == 'true' }}
        run: |
          SERVICE=${{ inputs.service_name }}
          if [ -z "$SERVICE" ]; then
            SERVICE=${{ inputs.image_name }}
          fi
          IMAGE_URI=${{ steps.build.outputs.image_uri }}
      
          echo "Updating Cloud Run service $SERVICE with latest image $IMAGE_URI"
          gcloud run services update "$SERVICE" \
            --image "$IMAGE_URI" \
            --region "${{ inputs.region }}"

